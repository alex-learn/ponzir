var net = require('net');

var Ponzir = function() {
  var self = this;
  var messageHandler = null;
  var debug = null;

  self.server = null;
  self.port = 12212;
  self.address = null; // A null means listen on any address
  self.establisher = false;
  self.name = '';

  debug = function(message) {
    console.log("[   DEBUG] " + message);
  };

  /**
   * Public Setter for port number
   */
  self.setPort = function(port) {
    debug("Setting port to: " + port);

    self.port = port;

    return self;
  };

  /**
   * Public Setter for IP Address
   */
  self.setAddress = function(address) {
    debug("Setting address to: " + address);

    self.address = address;

    return self;
  };

  /**
   * This Ponzir node is going to create a new Ponzir network
   */
  self.establish = function() {
    debug("Establishment mode");

    self.establisher = true;

    return self;
  };

  /**
   * Public method for creating a server. This should probably be a constructor.
   */
  self.create = function(name) {
    debug("Setting name to: " + name);

    self.name = name;

    debug("Creating a TCP server.");

    self.server = net.createServer(dispatcher);

    return self;
  };

  /**
   * Private method for handling incomming messages
   */
  dispatcher = function(socket) {
    debug("Dispatcher executing");

    console.log(socket);
    socket.write('Echo server\r\n');
    socket.pipe(socket);
  };

  /**
   * Public method for enabling a listener
   */
  self.listen = function(port, address) {
    debug("Listening for connections at " + (address || self.address || '*') + ":" + (port || self.port));
    self.server.listen(port || self.port, address || self.address);


    return self;
  };
};

module.exports = new Ponzir;
